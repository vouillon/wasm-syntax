#[import = ("fail", "caml_invalid_argument")]
fn caml_invalid_argument(&eq);
#[import = ("fail", "caml_failwith")]
fn caml_failwith(&eq);
type string = [mut i8];
type block = [mut &eq];
type char_table = [i8];
type int_array = [mut i32];
const re_word_letters: &char_table =
    [char_table|
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0xFF,
        0x03,
        0xFE,
        0xFF,
        0xFF,
        0x87,
        0xFE,
        0xFF,
        0xFF,
        0x07,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0xFF,
        0xFF,
        0x7F,
        0xFF,
        0xFF,
        0xFF,
        0x7F,
        0xFF];
type stack = open { f: &?stack };
type pos: stack = { pos_previous: &?stack, pc: i32, pos: i32 };
type undo: stack = {
    undo_previous: &?stack,
    tbl: &int_array,
    idx: i32,
    val: i32
};
fn is_word_letter(c: i32) -> i32 {
    1 & re_word_letters[c >>u 3] as i32_u >>u (c & 7);
}
fn in_bitset(s: &string, c: i32) -> i32 {
    1 & s[c >>u 3] as i32_u >>u (c & 7);
}
fn re_match(vre: &eq, s: &string, pos: i32, accept_partial_match: i32) -> &eq
{
    let res: &block;
    let s': &string;
    let set: &string;
    let len: i32;
    let instr: i32;
    let arg: i32;
    let i: i32;
    let j: i32;
    let l: i32;
    let re: &block;
    let prog: &block;
    let cpool: &block;
    let normtable: &string;
    let numgroups: i32;
    let numregisters: i32;
    let group_start: &int_array;
    let group_end: &int_array;
    let re_register: &int_array;
    let pc: i32;
    let stack: &?stack;
    let u: &undo;
    let p: &pos;
    len = s.length;
    re = vre as &block;
    prog = re[1] as &block;
    cpool = re[2] as &block;
    normtable = re[3] as &string;
    numgroups = re[4] as &i31 as i32_s;
    numregisters = re[5] as &i31 as i32_s;
    group_start = [int_array|-1; numgroups];
    group_end = [int_array|-1; numgroups];
    re_register = [int_array|-1; numregisters];
    pc = 1;
    group_start[0] = pos;
    'reject: do {
        'ACCEPT: do {
            'continue: loop {
                'backtrack: do {
                    'prefix_match: do {
                        'CHECKPROGRESS: do {
                            'SETMARK: do {
                                'PUSHBACK: do {
                                    'GOTO: do {
                                        'SIMPLEPLUS: do {
                                            'SIMPLESTAR: do {
                                                'SIMPLEOPT: do {
                                                    'REFGROUP: do {
                                                        'ENDGROUP: do {
                                                            'BEGGROUP: do {
                                                                'WORDBOUNDARY:
                                                                do {
                                                                    'EOL: do
                                                                    {
                                                                    'BOL: do
                                                                    {
                                                                    'CHARCLASS:
                                                                    do {
                                                                    'STRINGNORM:
                                                                    do {
                                                                    'STRING:
                                                                    do {
                                                                    'CHARNORM:
                                                                    do {
                                                                    'CHAR: do
                                                                    {
                                                                    instr =
                                                                    prog[pc]
                                                                    as &i31
                                                                    as i32_s;
                                                                    pc =
                                                                    pc + 1;
                                                                    br_table
                                                                    [ 'CHAR
                                                                    'CHARNORM
                                                                    'STRING
                                                                    'STRINGNORM
                                                                    'CHARCLASS
                                                                    'BOL 'EOL
                                                                    'WORDBOUNDARY
                                                                    'BEGGROUP
                                                                    'ENDGROUP
                                                                    'REFGROUP
                                                                    'ACCEPT
                                                                    'SIMPLEOPT
                                                                    'SIMPLESTAR
                                                                    'SIMPLEPLUS
                                                                    'GOTO
                                                                    'PUSHBACK
                                                                    'SETMARK
                                                                    else
                                                                    'CHECKPROGRESS
                                                                    ]
                                                                    instr &
                                                                    0xff;
                                                                    }
                                                                    br_if
                                                                    'prefix_match
                                                                    pos ==
                                                                    len;
                                                                    arg =
                                                                    instr >>u
                                                                    8;
                                                                    br_if
                                                                    'backtrack
                                                                    arg !=
                                                                    s[pos]
                                                                    as i32_u;
                                                                    pos =
                                                                    pos + 1;
                                                                    br
                                                                    'continue;
                                                                    }
                                                                    /* 'CHARNORM */
                                                                    br_if
                                                                    'prefix_match
                                                                    pos ==
                                                                    len;
                                                                    arg =
                                                                    instr >>u
                                                                    8;
                                                                    br_if
                                                                    'backtrack
                                                                    arg !=
                                                                    normtable
                                                                    [
                                                                    s[pos]
                                                                    as i32_u]
                                                                    as i32_u;
                                                                    pos =
                                                                    pos + 1;
                                                                    br
                                                                    'continue;
                                                                    }
                                                                    /* 'STRING */
                                                                    arg =
                                                                    instr >>u
                                                                    8;
                                                                    s' =
                                                                    cpool
                                                                    [arg + 1]
                                                                    as
                                                                    &string;
                                                                    i = 0;
                                                                    l =
                                                                    s'.length;
                                                                    'loop:
                                                                    loop {
                                                                    if 
                                                                    i <u l {
                                                                    br_if
                                                                    'prefix_match
                                                                    pos ==
                                                                    len;
                                                                    br_if
                                                                    'backtrack
                                                                    s'[i]
                                                                    as i32_u
                                                                    !=
                                                                    s[pos]
                                                                    as i32_u;
                                                                    pos =
                                                                    pos + 1;
                                                                    i = i + 1;
                                                                    br 'loop;
                                                                    }
                                                                    }
                                                                    /* 'loop */
                                                                    br
                                                                    'continue;
                                                                    }
                                                                    /* 'STRINGNORM */
                                                                    arg =
                                                                    instr >>u
                                                                    8;
                                                                    s' =
                                                                    cpool
                                                                    [arg + 1]
                                                                    as
                                                                    &string;
                                                                    i = 0;
                                                                    l =
                                                                    s'.length;
                                                                    'loop:
                                                                    loop {
                                                                    if 
                                                                    i <u l {
                                                                    br_if
                                                                    'prefix_match
                                                                    pos ==
                                                                    len;
                                                                    br_if
                                                                    'backtrack
                                                                    s'[i]
                                                                    as i32_u
                                                                    !=
                                                                    normtable
                                                                    [
                                                                    s[pos]
                                                                    as i32_u]
                                                                    as i32_u;
                                                                    pos =
                                                                    pos + 1;
                                                                    i = i + 1;
                                                                    br 'loop;
                                                                    }
                                                                    }
                                                                    /* 'loop */
                                                                    br
                                                                    'continue;
                                                                    }
                                                                    /* 'CHARCLASS */
                                                                    br_if
                                                                    'prefix_match
                                                                    pos ==
                                                                    len;
                                                                    arg =
                                                                    instr >>u
                                                                    8;
                                                                    br_if
                                                                    'backtrack
                                                                    !in_bitset
                                                                    (cpool
                                                                    [arg + 1]
                                                                    as
                                                                    &string,
                                                                    s[pos]
                                                                    as i32_u);
                                                                    pos =
                                                                    pos + 1;
                                                                    br
                                                                    'continue;
                                                                    }
                                                                    /* 'BOL */
                                                                    br_if
                                                                    'continue
                                                                    !pos;
                                                                    br_if
                                                                    'continue
                                                                    10 ==
                                                                    s
                                                                    [pos - 1]
                                                                    as i32_u;
                                                                    br
                                                                    'backtrack;
                                                                    }
                                                                    /* 'EOL */
                                                                    br_if
                                                                    'continue
                                                                    pos ==
                                                                    len;
                                                                    br_if
                                                                    'continue
                                                                    10 ==
                                                                    s[pos]
                                                                    as i32_u;
                                                                    br
                                                                    'backtrack;
                                                                }
                                                                /* 'WORDBOUNDARY */
                                                                if !pos {
                                                                    br_if
                                                                    'prefix_match
                                                                    pos ==
                                                                    len;
                                                                    br_if
                                                                    'continue
                                                                    is_word_letter
                                                                    (s[pos]
                                                                    as i32_u);
                                                                    br
                                                                    'backtrack;
                                                                } else {
                                                                    if
                                                                    pos ==
                                                                    len {
                                                                    br_if
                                                                    'continue
                                                                    is_word_letter
                                                                    (s
                                                                    [pos - 1]
                                                                    as i32_u);
                                                                    br
                                                                    'backtrack;
                                                                    } else {
                                                                    br_if
                                                                    'continue
                                                                    is_word_letter
                                                                    (s
                                                                    [pos - 1]
                                                                    as i32_u)
                                                                    !=
                                                                    is_word_letter
                                                                    (s[pos]
                                                                    as i32_u);
                                                                    br
                                                                    'backtrack;
                                                                    }
                                                                }
                                                            } /* 'BEGGROUP */
                                                            arg = instr >>u 8;
                                                            stack =
                                                                {undo|
                                                                    undo_previous:
                                                                    stack,
                                                                    tbl:
                                                                    group_start,
                                                                    idx: arg,
                                                                    val:
                                                                    group_start
                                                                    [arg]
                                                                };
                                                            group_start
                                                                [arg] = pos;
                                                            br 'continue;
                                                        } /* 'ENDGROUP */
                                                        arg = instr >>u 8;
                                                        stack =
                                                            {undo|
                                                                undo_previous:
                                                                    stack,
                                                                tbl:
                                                                    group_end,
                                                                idx: arg,
                                                                val:
                                                                    group_end
                                                                    [arg]
                                                            };
                                                        group_end[arg] = pos;
                                                        br 'continue;
                                                    } /* 'REFGROUP */
                                                    arg = instr >>u 8;
                                                    i = group_start[arg];
                                                    j = group_end[arg];
                                                    br_if 'backtrack
                                                        (i <s 0) | (j <s 0);
                                                    'loop: loop {
                                                        if i <u j {
                                                            br_if
                                                                'prefix_match
                                                                pos == len;
                                                            br_if 'backtrack
                                                                s[i] as i32_u
                                                                    !=
                                                                    s[pos]
                                                                    as i32_u;
                                                            pos = pos + 1;
                                                            i = i + 1;
                                                            br 'loop;
                                                        }
                                                    } /* 'loop */
                                                    br 'continue;
                                                } /* 'SIMPLEOPT */
                                                arg = instr >>u 8;
                                                if pos <u len {
                                                    if
                                                        in_bitset
                                                            (cpool[arg + 1]
                                                                 as &string,
                                                             s[pos] as i32_u)
                                                    {
                                                        pos = pos + 1;
                                                    }
                                                }
                                                br 'continue;
                                            } /* 'SIMPLESTAR */
                                            arg = instr >>u 8;
                                            set = cpool[arg + 1] as &string;
                                            'loop: loop {
                                                if pos <u len {
                                                    if
                                                        in_bitset
                                                            (set,
                                                             s[pos] as i32_u)
                                                    {
                                                        pos = pos + 1;
                                                        br 'loop;
                                                    }
                                                }
                                            } /* 'loop */
                                            br 'continue;
                                        } /* 'SIMPLEPLUS */
                                        br_if 'prefix_match pos == len;
                                        arg = instr >>u 8;
                                        set = cpool[arg + 1] as &string;
                                        br_if 'backtrack
                                            !in_bitset(set, s[pos] as i32_u);
                                        'loop: loop {
                                            pos = pos + 1;
                                            if pos <u len {
                                                br_if 'loop
                                                    in_bitset
                                                        (set, s[pos] as i32_u);
                                            }
                                        } /* 'loop */
                                        br 'continue;
                                    } /* 'GOTO */
                                    pc = pc + (instr >>s 8);
                                    br 'continue;
                                } /* 'PUSHBACK */
                                stack =
                                    {pos|
                                        pos_previous: stack,
                                        pc: pc + (instr >>s 8),
                                        pos: pos
                                    };
                                br 'continue;
                            } /* 'SETMARK */
                            arg = instr >>u 8;
                            stack =
                                {undo|
                                    undo_previous: stack,
                                    tbl: re_register,
                                    idx: arg,
                                    val: re_register[arg]
                                };
                            re_register[arg] = pos;
                            br 'continue;
                        } /* 'CHECKPROGRESS */
                        arg = instr >>u 8;
                        br_if 'backtrack pos == re_register[arg];
                        br 'continue;
                    } /* 'prefix_match */
                    br_if 'ACCEPT accept_partial_match;
                } /* 'backtrack */
                'loop: loop {
                    u =
                        'undo: do &stack {
                            p =
                                br_on_cast_fail 'undo &pos
                                    br_on_null 'reject stack;
                            pc = p.pc;
                            pos = p.pos;
                            stack = p.pos_previous;
                            br 'continue;
                        } /* 'undo */ as &undo;
                    u.tbl[u.idx] = u.val;
                    stack = u.undo_previous;
                    br 'loop;
                }
            } /* 'continue */
        } /* 'ACCEPT */
        group_end[0] = pos;
        res = [block|0 as &i31; (numgroups << 1) + 1];
        i = 0;
        'loop: loop {
            if i <u numgroups {
                j = i << 1;
                if (group_start[i] <s 0) | (group_end[i] <s 0) {
                    res[j + 1] = -1 as &i31;
                    res[j + 2] = -1 as &i31;
                } else {
                    res[j + 1] = group_start[i] as &i31;
                    res[j + 2] = group_end[i] as &i31;
                }
                i = i + 1;
                br 'loop;
            }
        } /* 'loop */
        return res;
    } /* 'reject */
    0 as &i31;
}
#[export = "re_search_forward"]
fn re_search_forward(re: &eq, vs: &eq, vpos: &eq) -> &eq {
    let s: &string;
    let pos: i32;
    let len: i32;
    let res: &eq;
    s = vs as &string;
    pos = vpos as &i31 as i32_s;
    len = s.length;
    if pos >u len { caml_invalid_argument(string#"foo"); }
    'loop: loop {
        res = re_match(re, s, pos, 0);
        if res is &block { return res; }
        pos = pos + 1;
        br_if 'loop pos <=u len;
    } /* 'loop */
    [block|0 as &i31];
}
#[export = "re_search_backward"]
fn re_search_backward(re: &eq, vs: &eq, vpos: &eq) -> &eq {
    let s: &string;
    let pos: i32;
    let len: i32;
    let res: &eq;
    s = vs as &string;
    pos = vpos as &i31 as i32_s;
    len = s.length;
    if pos >u len { caml_invalid_argument(string#"foo"); }
    'loop: loop {
        res = re_match(re, s, pos, 0);
        if res is &block { return res; }
        pos = pos - 1;
        br_if 'loop pos >=s 0;
    } /* 'loop */
    [block|0 as &i31];
}
#[export = "re_string_match"]
fn re_string_match(re: &eq, vs: &eq, vpos: &eq) -> &eq {
    let s: &string;
    let pos: i32;
    let len: i32;
    let res: &eq;
    s = vs as &string;
    pos = vpos as &i31 as i32_s;
    len = s.length;
    if pos >u len { caml_invalid_argument(string#"foo"); }
    res = re_match(re, s, pos, 0);
    if res is &block { return res; }
    [block|0 as &i31];
}
#[export = "re_partial_match"]
fn re_partial_match(re: &eq, vs: &eq, vpos: &eq) -> &eq {
    let s: &string;
    let pos: i32;
    let len: i32;
    let res: &eq;
    s = vs as &string;
    pos = vpos as &i31 as i32_s;
    len = s.length;
    if pos >u len { caml_invalid_argument(string#"foo"); }
    res = re_match(re, s, pos, 1);
    if res is &block { return res; }
    [block|0 as &i31];
}
#[export = "re_replacement_text"]
fn re_replacement_text(vrepl: &eq, vgroups: &eq, vorig: &eq) -> &eq {
    let repl: &string;
    let groups: &block;
    let orig: &string;
    let res: &string;
    let i: i32;
    let j: i32;
    let l: i32;
    let len: i32;
    let c: i32;
    let start: i32;
    let end: i32;
    repl = vrepl as &string;
    l = repl.length;
    groups = vgroups as &block;
    orig = vorig as &string;
    'loop: loop {
        if i <u l {
            c = repl[i] as i32_u;
            i = i + 1;
            if c != 92 { len = len + 1; br 'loop; }
            if i == l { caml_failwith(string#"foo"); }
            c = repl[i] as i32_u;
            i = i + 1;
            if c == 92 { len = len + 1; br 'loop; }
            c = c - 48;
            if c >u 9 { len = len + 2; br 'loop; }
            c = c << 1;
            if c + 1 >u groups.length { caml_failwith(string#"foo"); }
            start = groups[c + 1] as &i31 as i32_s;
            end = groups[c + 2] as &i31 as i32_s;
            if start == -1 { caml_failwith(string#"foo"); }
            len = len + (end - start);
            br 'loop;
        }
    } /* 'loop */
    res = [string|0; len];
    i = 0;
    'loop: loop {
        if i <u l {
            c = repl[i] as i32_u;
            i = i + 1;
            if c != 92 { res[j] = c; j = j + 1; br 'loop; }
            c = repl[i] as i32_u;
            i = i + 1;
            if c == 92 { res[j] = c; j = j + 1; br 'loop; }
            c = c - 48;
            if c >u 9 {
                res[j] = 92;
                res[j + 1] = c + 48;
                j = j + 2;
                br 'loop;
            }
            c = c << 1;
            if c + 1 >u groups.length { caml_failwith(string#"foo"); }
            start = groups[c + 1] as &i31 as i32_s;
            end = groups[c + 2] as &i31 as i32_s;
            len = end - start;
            res.copy(j, orig, start, len);
            j = j + len;
            br 'loop;
        }
    } /* 'loop */
    res;
}
