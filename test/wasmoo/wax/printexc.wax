#[import = ("jslib", "unwrap")] fn unwrap(_: &eq) -> &?any
#[import = ("jslib", "caml_jsstring_of_string")]
fn caml_jsstring_of_string(_: &eq) -> &eq
#[import = ("fail", "caml_is_special_exception")]
fn caml_is_special_exception(_: &eq) -> i32
#[import = ("ints", "caml_format_int")]
fn caml_format_int(_: &eq, _: &eq) -> &eq
type block = [mut &eq]
type string = [mut i8]
type buffer = { f: mut i32, f_2: &string }
fn add_char(buf: &buffer, c: i32) {
    let pos: i32;
    let data: &string;
    pos = buf.f;
    data = buf.f_2;
    if pos <u data.length { data[pos] = c; buf.f = pos + 1; }
}
fn add_string(buf: &buffer, v: &eq) {
    let pos: i32;
    let len: i32;
    let data: &string;
    let s: &string;
    pos = buf.f;
    data = buf.f_2;
    s = v as &string;
    len = s.length;
    if pos + len >u data.length { len = data.length - pos; }
    data.copy(pos, s, 0, len);
    buf.f = pos + len;
}
#[export = "caml_format_exception"]
fn caml_format_exception(x: &eq) -> &eq {
    let exn: &block;
    let buf: &buffer;
    let v: &eq;
    let bucket: &block;
    let i: i32;
    let len: i32;
    let s: &string;
    exn = x as &block;
    if exn[0] == 0 as &i31 => &eq {
        buf = {buffer| f: 0, f_2: [string| 0; 256] };
        add_string(buf, (exn[1] as &block)[1]);
        bucket =
            'continue: do &block {
                'default: {
                    br_if 'default exn.length != 3;
                    br_if 'default !caml_is_special_exception(exn[1]);
                    v = exn[2];
                    br_if 'default !(v is &block);
                    bucket = v as &block;
                    br_if 'default !(bucket[0] == 0 as &i31);
                    i = 1;
                    br 'continue bucket;
                } /* 'default */
                i = 2;
                exn;
            } /* 'continue */;
        len = bucket.length;
        if i <u len {
            add_char(buf, 40);
            'loop: loop {
                v = bucket[i];
                if v is &i31 {
                    add_string(buf, caml_format_int(string#"%d", v as &i31));
                } else {
                    if v is &string {
                        add_char(buf, 34);
                        add_string(buf, v);
                        add_char(buf, 34);
                    } else { add_char(buf, 95); }
                }
                i = i + 1;
                if i <u len {
                    add_char(buf, 44);
                    add_char(buf, 32);
                    br 'loop;
                }
            } /* 'loop */
            add_char(buf, 41);
        }
        s = [string| 0; buf.f];
        s.copy(0, buf.f_2, 0, buf.f);
        s;
    } else { exn[1]; }
}
